---
import '../styles/global.css'
import Layout from "../layouts/Layout.astro";

import AppHeader from '../components/Header.astro';
import AppFooter from '../components/Footer.astro';
import {author} from "../sample";
import Button from "../components/Button.astro";
import svgPinkStar from '../assets/pink-star.svg'
// 1. è·å–åŸå§‹å¯¹è±¡ï¼ˆåŒ…å«è·¯å¾„å’Œå†…å®¹ï¼‰
const globFiles = import.meta.glob('./friends/*.md', { eager: true });

// 2. æå–å¹¶æ’åº
const allFriends = Object.entries(globFiles)
    .sort(([pathA], [pathB]) => {
        // ä½¿ç”¨ localeCompare çš„æ•°å­—æ¨¡å¼è¿›è¡Œè‡ªç„¶æ’åº
        return pathA.localeCompare(pathB, undefined, {
            numeric: true,
            sensitivity: 'base'
        });
    })
    .map(([path, module]) => module); // åªä¿ç•™æ¨¡å—å†…å®¹
---

<Layout>
    <AppHeader />
    <section class="py-40">
        <div class="max-w-6xl mx-auto px-4">
            <div class="text-center mb-15">
                <h1 class="title text-5xl font-black">å‹é“¾</h1>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-3">

                <!--ç½®é¡¶ â¤ï¸ yeastar (ç‰¹æ•ˆç‰ˆ)-->
                <div class="col-span-1 md:col-span-2 mb-4 relative min-h-[280px] md:min-h-[220px]" id="pin-card-wrapper">

                    <!-- ç¢ç‰‡å®¹å™¨ (åŠ¨ç”»æ—¶æ˜¾ç¤º) -->
                    <div id="fragment-container" class="absolute inset-0 z-20 pointer-events-none overflow-visible"></div>

                    <!-- çœŸå®å¡ç‰‡å†…å®¹ (åˆå§‹éšè—ï¼ŒåŠ¨ç”»åæ˜¾ç°) -->
                    <a
                            id="real-card"
                            href="https://yeastar.xin/"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="group flex flex-col md:flex-row gap-6 items-center bg-[var(--purple)] p-8 border-4 border-black transition-all duration-200 hover:shadow-[12px_12px_0px_rgba(0,0,0,1)] hover:-translate-y-1 active:translate-y-0 active:shadow-none relative overflow-hidden"
                    >
                        <!-- æ‚¬æµ®é˜´å½± (å•ç‹¬åšå±‚ä»¥é…åˆåŠ¨ç”») -->
                        <!--<div class="absolute inset-0 border-4 border-black transition-all duration-200 group-hover:shadow-[12px_12px_0px_rgba(0,0,0,1)] pointer-events-none z-10"></div>-->

                        <!-- Pin æ ‡ç­¾ -->
                        <div class="reveal-item absolute top-0 right-0 bg-black text-white px-4 py-1 font-black text-sm uppercase tracking-widest z-20">
                            Pin â¤ï¸
                        </div>

                        <!-- å¤´åƒéƒ¨åˆ† -->
                        <div class="flex-shrink-0 z-10 reveal-item">
                            <div class="w-[120px] h-[120px] sm:w-[150px] sm:h-[150px] overflow-hidden border-4 border-black shadow-[4px_4px_0px_black] bg-white">
                                <img src="/yueosa.jpg" alt="her avatar" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                            </div>
                        </div>

                        <!-- æ–‡å­—éƒ¨åˆ† -->
                        <div class="flex flex-col gap-3 text-center md:text-left z-10 w-full">
                            <h2 class="reveal-item text-3xl md:text-4xl font-black italic">YukiKoi</h2>
                            <p class="reveal-item text-lg text-gray-800 font-bold leading-relaxed delay-100">
                                æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œ, è¿™é‡Œæ²¡æœ‰ç¥, åªæœ‰æˆ‘æ„ç­‘çš„ä»£ç ã€è®°å¿†å’Œå…‰
                            </p>
                            <div class="reveal-item flex items-center justify-center md:justify-start gap-2 delay-200">
                                <span class="bg-black text-white px-2 py-0.5 text-xs font-mono">
                                    {"https://yeastar.xin".replace(/^https?:\/\//, '')}
                                </span>
                                <span class="text-2xl animate-bounce">â˜†</span>
                            </div>
                        </div>
                    </a>
                </div>
                <!--ç½®é¡¶ç»“æŸ-->

                <div class="col-span-1 md:col-span-2 pt-10 pb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-black border-b-4 border-black pb-1">
                            æˆ‘ çš„ æœ‹ å‹
                        </h2>
                        <span class="text-2xl"></span>
                    </div>
                    <p class="mt-2 text-gray-600 font-bold font-mono text-sm uppercase tracking-tighter">
                        æˆ‘ä¼šæ°¸è¿œè®°ä½ä½ ä»¬æœ‰è¶£çš„çµé­‚
                    </p>
                </div>

                {allFriends.map(({ frontmatter }: any) => (
                        <a
                                href={frontmatter.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex gap-4 items-center bg-white p-5 border-2 border-black transition-all duration-200 hover:shadow-[4px_4px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5 active:translate-y-0 active:shadow-none"
                        >
                            <div class="flex-shrink-0">
                                <div class="w-[80px] h-[80px] sm:w-[100px] sm:h-[100px] overflow-hidden border-2 border-black">
                                    <img src={frontmatter.avatar} alt={frontmatter.name} class="w-full h-full object-cover" loading="lazy" decoding="async" />
                                </div>
                            </div>
                            <div class="flex flex-col gap-1 overflow-hidden">
                                <h1 class="text-xl font-bold truncate">{frontmatter.name}</h1>
                                <div class="line-clamp-2 text-gray-600 text-sm" set:html={frontmatter.description}></div>
                                <span class="text-xs text-[var(--vanilla)] font-mono mt-1 truncate">{frontmatter.url.replace(/^https?:\/\//, '')}</span>
                            </div>
                        </a>
                ))}
            </div>
        </div>

        <div class="mt-66 max-w-3xl mx-auto bg-white text-center flex flex-col gap-4 border-3 shadow-[8px_8px_0px_rgba(0,0,0,0.3)] relative p-10">
            <h1 class="text-3xl">æ·»åŠ æˆ‘ï¼Ÿ</h1>
            <pre class="bg-gray-50 text-gray-800 p-6 border-2 border-black shadow-[4px_4px_0px_rgba(0,0,0,1)] overflow-x-auto text-left">
                <code class="font-mono text-sm leading-relaxed whitespace-pre">
<span class="text-[var(--red-deep)] font-bold">name:</span> <span class="text-green-800">"Duo äº‘ç«™"</span>
<span class="text-[var(--red-deep)] font-bold">description:</span> <span class="text-green-800">"MathForestå®˜æ–¹ğŸŒ²|ç¨‹åºåŠæ•°å­¦å¯è§†åŒ–âœ¨|å±‘é­”å¥³æ¸¸ä¸–ç•ŒğŸ”®"</span>
<span class="text-[var(--red-deep)] font-bold">avatar:</span> <span class="text-green-800">"https://www.mduo.cloud/elaina_q.jpg"</span>
<span class="text-[var(--red-deep)] font-bold">url:</span> <span class="text-green-800">"https://www.mduo.cloud/"</span>
                </code>
            </pre>
            <img src={svgPinkStar.src} alt="svg" width="80" class="absolute -top-10 right-20" />
        </div>
    </section>
    <AppFooter />
</Layout>

<style>
    /* ç¢ç‰‡çš„åŸºç¡€æ ·å¼ */
    :global(.shard) {
        position: absolute;
        background-color: var(--purple); /* å¯¹åº”å¡ç‰‡èƒŒæ™¯è‰² */
        opacity: 0;
        /* ä½¿ç”¨è‡ªå®šä¹‰å˜é‡æ§åˆ¶åˆå§‹ä½ç½® */
        transform: translate3d(var(--tx), var(--ty), 0) scale(0) rotate(var(--r));
        transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease-in;
        will-change: transform, opacity;
        z-index: 50;
    }

    /* ç¢ç‰‡èšåˆæ€ */
    :global(.shard.assembled) {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1.01) rotate(0deg); /* scale 1.01 é˜²æ­¢ç¼éš™ */
    }

    /* çœŸå®å¡ç‰‡æ˜¾ç° */
    .card-visible {
        animation: cardFadeIn 0.1s forwards;
    }

    @keyframes cardFadeIn {
        to { opacity: 1; }
    }

    /* å†…å®¹å±•å¼€åŠ¨ç”» */
    .reveal-item {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .card-visible .reveal-item {
        opacity: 1;
        transform: translateY(0);
    }

    /* äº¤é”™å»¶è¿Ÿ */
    .card-visible .reveal-item:nth-child(1) { transition-delay: 0.1s; }
    .card-visible .reveal-item:nth-child(2) { transition-delay: 0.2s; }
    .card-visible .reveal-item:nth-child(3) { transition-delay: 0.3s; }
    /* æ–‡å­—éƒ¨åˆ†å†…éƒ¨çš„å»¶è¿Ÿ */
    .card-visible .flex-col .reveal-item:nth-child(1) { transition-delay: 0.2s; }
    .card-visible .flex-col .reveal-item:nth-child(2) { transition-delay: 0.3s; }
    .card-visible .flex-col .reveal-item:nth-child(3) { transition-delay: 0.4s; }

</style>

<script>
    function initCardAnimation() {
        const container = document.getElementById('fragment-container');
        const realCard = document.getElementById('real-card');
        const wrapper = document.getElementById('pin-card-wrapper');

        if (!container || !realCard || !wrapper) return;

        // æ¸…ç†æ—§ç¢ç‰‡ï¼ˆé˜²æ­¢çƒ­é‡è½½æˆ–è·¯ç”±è·³è½¬é‡å¤ç”Ÿæˆï¼‰
        container.innerHTML = '';
        realCard.classList.remove('card-visible');
        realCard.style.opacity = '0';

        // é…ç½®ï¼šç½‘æ ¼è¡Œåˆ—æ•°
        const cols = 12;
        const rows = 6;

        const width = wrapper.offsetWidth;
        const height = wrapper.offsetHeight;

        const cellW = width / cols;
        const cellH = height / rows;

        const shards = [];

        // ç”Ÿæˆç¢ç‰‡
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const shard = document.createElement('div');
                shard.classList.add('shard');

                // è®¾å®šå®½é«˜å’Œä½ç½®
                shard.style.width = `${Math.ceil(cellW)}px`;
                shard.style.height = `${Math.ceil(cellH)}px`;
                shard.style.left = `${c * cellW}px`;
                shard.style.top = `${r * cellH}px`;

                // éšæœºç”Ÿæˆé£å…¥å‰çš„åç§»é‡ (ä»å±å¹•å¤–å››é¢å…«æ–¹é£æ¥)
                // èŒƒå›´æ‰©å¤§åˆ° 500px - 1000px ä¹‹å¤–
                const randomX = (Math.random() - 0.5) * window.innerWidth * 1.5;
                const randomY = (Math.random() - 0.5) * window.innerHeight * 1.5;
                const randomRotate = (Math.random() - 0.5) * 360;

                shard.style.setProperty('--tx', `${randomX}px`);
                shard.style.setProperty('--ty', `${randomY}px`);
                shard.style.setProperty('--r', `${randomRotate}deg`);

                // éšæœºå»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©é£å…¥æ›´æœ‰å±‚æ¬¡æ„Ÿï¼Œè€Œä¸æ˜¯æ•´é½åˆ’ä¸€
                shard.style.transitionDelay = `${Math.random() * 0.2}s`;

                container.appendChild(shard);
                shards.push(shard);
            }
        }

        // è§¦å‘åŠ¨ç”»ï¼šå¼ºåˆ¶é‡ç»˜åæ·»åŠ ç±»å
        requestAnimationFrame(() => {
            // ç»™ä¸€ä¸ªå°å°çš„å»¶è¿Ÿç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(() => {
                shards.forEach(s => s.classList.add('assembled'));
            }, 50);
        });

        // ç¢ç‰‡æ±‡èšå®Œæˆåï¼Œæ˜¾ç¤ºçœŸå¡ç‰‡ï¼Œç§»é™¤ç¢ç‰‡
        // CSS transition æ˜¯ 0.8s + max delay 0.2s = 1.0s å·¦å³
        setTimeout(() => {
            realCard.classList.add('card-visible');

            // çœŸå®å¡ç‰‡å‡ºæ¥åï¼Œç¨å¾®ç­‰ä¸€ä¸‹å†ç§»é™¤ç¢ç‰‡ï¼Œé¿å…é—ªçƒ
            setTimeout(() => {
                container.innerHTML = ''; // ç§»é™¤ç¢ç‰‡å‡è½»DOMå‹åŠ›
            }, 200);

        }, 900);
    }

    // åœ¨ Astro é¡µé¢åŠ è½½æ—¶è¿è¡Œ
    document.addEventListener('DOMContentLoaded', initCardAnimation);
    // å…¼å®¹ Astro View Transitions (å¦‚æœåç»­å¼€å¯äº†è§†å›¾è¿‡æ¸¡)
    document.addEventListener('astro:page-load', initCardAnimation);
</script>