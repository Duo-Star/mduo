---
import { Image } from 'astro:assets';
import Layout from "../../layouts/Layout.astro"; // æ³¨æ„è·¯å¾„å¯èƒ½éœ€è¦è°ƒæ•´ï¼Œæ ¹æ®ä½ çš„æ–‡ä»¶å¤¹ç»“æ„
import AppHeader from '../../components/Header.astro';
import AppFooter from '../../components/Footer.astro';
import '../../styles/global.css';

// --- æ ¸å¿ƒé€»è¾‘ï¼šé™æ€è·¯å¾„ç”Ÿæˆ ---
export async function getStaticPaths({ paginate }) {
    // 1. è·å–æ‰€æœ‰å›¾ç‰‡
    const imageFiles = import.meta.glob('/src/assets/gallery/*.{jpeg,jpg,png,gif,webp}');

    // 2. è§£æå›¾ç‰‡æ•°æ®
    const rawImages = await Promise.all(
        Object.keys(imageFiles).map(async (path) => {
            const img = await imageFiles[path]() as any;
            return {
                path,
                data: img.default,
                name: path.split('/').pop()?.split('.').shift() || 'Untitled'
            };
        })
    );

    // 3. æ’åº (ä¿è¯æ„å»ºæ—¶é¡ºåºä¸€è‡´)
    const allImages = rawImages.sort((a, b) => a.name.localeCompare(b.name));

    // 4. æå–ç½®é¡¶å›¾é€»è¾‘ (æ„å»ºæ—¶æ‰§è¡Œ)
    // ä½¿ç”¨æ—¥æœŸä½œä¸ºç§å­ï¼Œæˆ–è€…ç›´æ¥éšæœºï¼ˆå› ä¸ºæ˜¯é™æ€æ„å»ºï¼Œä¸‹æ¬¡éƒ¨ç½²å‰ä¸ä¼šå˜ï¼Œæ‰€ä»¥ç›´æ¥éšæœºä¹Ÿæ²¡é—®é¢˜ï¼‰
    let listImages = [...allImages];
    let heroImage = null;

    if (listImages.length > 0) {
        // è¿™é‡Œå¯ä»¥ç›´æ¥éšæœºï¼Œå› ä¸ºæ„å»ºå®Œæˆåï¼ŒHTMLå°±æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šå‡ºç°åˆ·æ–°å˜åŠ¨çš„é—®é¢˜
        const randomIndex = Math.floor(Math.random() * listImages.length);
        heroImage = listImages[randomIndex];
        listImages.splice(randomIndex, 1); // ä»åˆ—è¡¨ç§»é™¤
    }

    // 5. ç”Ÿæˆåˆ†é¡µ
    // paginate ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆ /gallery/1, /gallery/2 ç­‰è·¯å¾„
    // å¹¶å°†æ•°æ®é€šè¿‡ props.page ä¼ é€’ç»™é¡µé¢
    return paginate(listImages, {
        pageSize: 9,
        props: { heroImage }, // å°†ç½®é¡¶å›¾ä¼ é€’ç»™æ‰€æœ‰é¡µé¢ï¼Œä½†åœ¨æ¨¡æ¿é‡Œæˆ‘ä»¬åªåœ¨ç¬¬ä¸€é¡µæ˜¾ç¤º
    });
}

// --- é¡µé¢é€»è¾‘ ---
const { page, heroImage } = Astro.props; // è·å– paginate ä¼ é€’çš„æ•°æ®
const { data: images, currentPage, lastPage, url } = page;
---

<Layout>
    <AppHeader />

    <section class="py-20 min-h-screen bg-[var(--main-bg)] overflow-x-hidden">
        <div class="max-w-6xl mx-auto px-4">

            <div class="text-center mb-12">
                <h1 class="title text-5xl font-black">ç›¸å†Œ</h1>
                <p class="mt-4 text-gray-500 font-mono">
                    PAGE: {currentPage}/{lastPage}
                </p>
            </div>

            {/* --- ğŸŒŸ ç¬¬ä¸€é¡µï¼šç½®é¡¶å¤§å›¾åŒºåŸŸ --- */}
            {/* åªæœ‰åœ¨ç¬¬1é¡µ (currentPage === 1) ä¸”æœ‰ heroImage æ—¶æ˜¾ç¤º */}
            {currentPage === 1 && heroImage && (
                    <div class="mb-20 animate-fade-in-down">
                        <div class="relative bg-white border-4 border-black p-4 shadow-[12px_12px_0px_rgba(0,0,0,1)] transition-transform hover:-translate-y-1">

                            {/* è£…é¥°æ€§æ ‡ç­¾ */}
                            <div class="absolute -top-6 -left-2 bg-[var(--purple-m)] text-white font-black px-6 py-2 border-4 border-black transform -rotate-2 z-10 shadow-[4px_4px_0px_black]">
                                æ‰‹ æ°” ä¸ é”™
                            </div>

                            <div class="w-full h-[400px] md:h-[500px] overflow-hidden border-2 border-black relative group">
                                <Image
                                        src={heroImage.data}
                                        alt={heroImage.name}
                                        width={1200}
                                        height={800}
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                                        loading="eager"
                                />
                                {/* å¤§å›¾ä¸Šçš„æ–‡å­—é®ç½© */}
                                <div class="absolute bottom-0 left-0 w-full bg-black/70 p-4 text-white translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                    <h2 class="text-2xl font-bold font-mono">{heroImage.name}</h2>
                                </div>
                            </div>
                        </div>
                    </div>
            )}
            {/* --- ç½®é¡¶ç»“æŸ --- */}

            {/* å›¾ç‰‡ç½‘æ ¼ */}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                {images.map((img: any, index: number) => (
                        <div
                                class="gallery-item group bg-white border-2 border-black p-3 transition-all duration-300 hover:shadow-[8px_8px_0px_rgba(0,0,0,1)] hover:-translate-y-1"
                                style={`animation-delay: ${index * 100}ms`}
                        >
                            <div class="relative w-full pb-[100%] overflow-hidden border-2 border-black mb-4 bg-gray-100">
                                <Image
                                        src={img.data}
                                        alt={img.name}
                                        width={600}
                                        height={600}
                                        class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                                />
                            </div>
                            <div class="flex justify-between items-center border-t-2 border-black pt-2">
                                <span class="font-bold text-lg uppercase tracking-wider truncate pr-2">{img.name}</span>
                                <span class="text-xs font-mono text-gray-500">IMG_{index + 1}</span>
                            </div>
                        </div>
                ))}
            </div>

            {/* --- ğŸ“Œ åˆ†é¡µæŒ‡ç¤ºå™¨ (ä½¿ç”¨ url.prev å’Œ url.next) --- */}
            {lastPage > 1 && (
                    <div class="mt-20 flex flex-wrap justify-center items-center gap-3">
                        {/* ä¸Šä¸€é¡µ */}
                        {url.prev ? (
                                <a href={url.prev} class="pagination-btn bg-white">
                                    &lt; PREV
                                </a>
                        ) : (
                                <span class="pagination-btn opacity-50 cursor-not-allowed bg-gray-200">
                                    &lt; PREV
                                </span>
                        )}

                        {/* é¡µç æ•°å­—ï¼šè™½ç„¶ Astro paginate æ²¡ç›´æ¥ç»™é¡µç æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® lastPage è‡ªå·±ç”Ÿæˆ */}
                        {Array.from({ length: lastPage }, (_, i) => i + 1).map((p) => (
                                <a
                                        href={p === 1 ? '/gallery/1' : `/gallery/${p}`}
                                        class={`pagination-btn w-12 flex justify-center ${p === currentPage ? 'bg-[var(--purple)] text-white hover:bg-gray-200' : 'bg-white '}`}
                                >
                                    {p}
                                </a>
                        ))}

                        {/* ä¸‹ä¸€é¡µ */}
                        {url.next ? (
                                <a href={url.next} class="pagination-btn bg-white">
                                    NEXT &gt;
                                </a>
                        ) : (
                                <span class="pagination-btn opacity-50 cursor-not-allowed bg-gray-200">
                                    NEXT &gt;
                                </span>
                        )}
                    </div>
            )}

            {/* åˆ†é¡µä¿¡æ¯æ–‡æœ¬ */}
            <div class="text-center mt-6 text-sm font-mono text-gray-500">
                PAGE {currentPage} OF {lastPage}
            </div>

        </div>
    </section>

    <AppFooter />
</Layout>

<style is:global>
    /* ä¿æŒåŸæœ‰çš„ CSS ä¸å˜ */
    .gallery-item {
        opacity: 0;
        animation: galleryFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-fade-in-down {
        animation: galleryFadeIn 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes galleryFadeIn {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .pagination-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 3rem;
        padding-left: 1rem;
        padding-right: 1rem;
        border-width: 2px;
        border-color: black;
        font-weight: 900;
        font-family: monospace;
        transition: all 0.2s;
        box-shadow: 4px 4px 0px rgba(0,0,0,1);
        text-decoration: none; /* ç¡®ä¿é“¾æ¥æ²¡æœ‰ä¸‹åˆ’çº¿ */
        color: inherit;
    }

    .pagination-btn:hover:not(.cursor-not-allowed) {
        transform: translateY(-2px);
        box-shadow: 6px 6px 0px rgba(0,0,0,1);
    }

    .pagination-btn:active:not(.cursor-not-allowed) {
        transform: translateY(0);
        box-shadow: 2px 2px 0px rgba(0,0,0,1);
    }
</style>